---
/**
 * Page dâ€™accueil : actus (colonne principale) + CleaReconDL (colonne gauche).
 * - Import des contenus Markdown gÃ©nÃ©rÃ©s par les scripts.
 * - Colonne gauche = tout l'historique, avec dÃ©doublonnage par URL finale.
 */

const modules = import.meta.glob('/src/content/papers/*.md', { eager: true });

// ðŸ‘‰ importe des DEUX chemins possibles (casse diffÃ©rente) pour la colonne gauche
const clRaw = {
  ...import.meta.glob('/src/content/clearecondl/*.md', { eager: true }),
  ...import.meta.glob('/src/content/cleareconDL/*.md', { eager: true }),
};

/* --------- Helpers --------- */
function normalizeUrl(u: string) {
  try {
    const x = new URL(u);
    return (x.origin + x.pathname).replace(/\/+$/, '').toLowerCase();
  } catch {
    return (u || '').toLowerCase();
  }
}
function hostOf(url: string) {
  try { return new URL(url).hostname.replace(/^www\./, ''); } catch { return ''; }
}
const brandMap: Record<string, string> = {
  'francetvinfo.fr': 'Franceinfo',
  'france24.com': 'France 24',
  'rfi.fr': 'RFI',
  '20minutes.fr': '20 Minutes',
  'ouest-france.fr': 'Ouest-France',
  'lemonde.fr': 'Le Monde',
};
function brandOf(url: string) {
  const h = hostOf(url);
  return brandMap[h] || h || 'Source';
}
function faviconOf(url: string) {
  const h = hostOf(url);
  return h ? `https://www.google.com/s2/favicons?domain=${h}&sz=64` : '';
}
function truncate(s: string, n = 160) {
  const x = (s || '').trim();
  return x.length > n ? x.slice(0, n - 1) + 'â€¦' : x;
}

/* --------- DonnÃ©es --------- */
const posts = Object.values(modules)
  .map((m) => (m as any).frontmatter)
  .filter((fm: any) => fm && fm.title && fm.sourceUrl)
  .sort((a: any, b: any) => new Date(b.date).getTime() - new Date(a.date).getTime());

// Colonne gauche : fusion des deux dossiers + tri + DÃ‰DOUBLONNAGE par sourceUrl normalisÃ©e
const leftPostsAll = Object.values(clRaw)
  .map((m) => (m as any).frontmatter)
  .filter((fm: any) => fm && fm.title && fm.sourceUrl)
  .sort((a: any, b: any) => new Date(b.date).getTime() - new Date(a.date).getTime());

const seenLeft = new Set<string>();
const leftPosts = leftPostsAll.filter((p: any) => {
  const key = normalizeUrl(p.sourceUrl);
  if (seenLeft.has(key)) return false;
  seenLeft.add(key);
  return true;
});
---
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <title>ActualitÃ©s â€” France</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
  </head>
  <body style="background:#D9D9D9; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0; min-height:100vh;">
    <div style="max-width: 1180px; margin: 0 auto; padding: 24px;">
      <header>
        <h1 style="margin:0 0 8px 0;">ActualitÃ©s â€” France</h1>
        <p style="opacity:.7;margin:0;">Une info du jour, en franÃ§ais.</p>
      </header>

      <div style="display:grid; grid-template-columns: 320px 1fr; gap: 20px; align-items:start; margin-top:24px;">
        <!-- Colonne gauche : CleaReconDL -->
        <aside style="position:sticky; top:16px; align-self:start;">
          <section style="background:#fff; border:1px solid #eaeaea; border-radius:14px; padding:14px; box-shadow:0 1px 2px rgba(0,0,0,.04);">
            <h2 style="margin:0 0 6px 0; font-size:18px;">En ce moment : <span style="white-space:nowrap;">CleaRecon&nbsp;DL</span></h2>
            <div style="opacity:.6; font-size:12px; margin:0 0 10px 0;">{leftPosts.length} Ã©lÃ©ment(s)</div>

            {
              leftPosts.length === 0
                ? (
                  <p style="margin:6px 0 0 0; opacity:.7; font-size:14px;">
                    Rien pour lâ€™instant. Lance <code>npm run generate:clearecondl</code> puis rebuild.
                  </p>
                )
                : (
                  <ul style="list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:10px; max-height:70vh; overflow:auto;">
                    {leftPosts.map((p: any) => (
                      <li>
                        <a
                          href={p.sourceUrl}
                          target="_blank"
                          rel="noopener noreferrer"
                          style="display:flex; gap:10px; text-decoration:none; color:inherit; background:#fff; border:1px solid #eee; border-radius:10px; padding:10px;"
                          aria-label={`Ouvrir : ${p.title}`}
                        >
                          {p.imageUrl ? (
                            <img
                              src={p.imageUrl}
                              alt=""
                              loading="lazy"
                              width="64"
                              height="64"
                              style="flex:0 0 64px; width:64px; height:64px; object-fit:cover; border-radius:8px; background:#f6f6f6;"
                            />
                          ) : (
                            <div style="flex:0 0 64px; width:64px; height:64px; border-radius:8px; background:#f6f6f6; display:flex; align-items:center; justify-content:center; font-size:12px; color:#777;">
                              {faviconOf(p.sourceUrl) ? <img src={faviconOf(p.sourceUrl)} alt="" width="20" height="20" /> : 'â€”'}
                            </div>
                          )}
                          <div style="min-width:0;">
                            <div style="font-weight:600; line-height:1.25; margin-bottom:4px; font-size:14px;">
                              {p.title}
                            </div>
                            <div style="opacity:.75; font-size:12px; margin-bottom:4px;">
                              {new Date(p.date).toLocaleDateString('fr-FR')}
                              {hostOf(p.sourceUrl) ? ` Â· ${hostOf(p.sourceUrl)}` : ''}
                            </div>
                            <div style="font-size:13px; opacity:.9;">
                              {truncate(p.summary, 160)}
                            </div>
                          </div>
                        </a>
                      </li>
                    ))}
                  </ul>
                )
            }
          </section>
        </aside>

        <!-- Colonne principale : actus -->
        {
          posts.length === 0
            ? (
              <p style="margin-top:6px; opacity:.8;">
                Aucune actualitÃ© pour lâ€™instant. Relance le workflow et recharge la page.
              </p>
            )
            : (
              <main style="display:grid; gap:16px; grid-template-columns: repeat(auto-fit, minmax(280px,1fr));">
                {posts.map((p: any) => (
                  <a
                    href={p.sourceUrl}
                    target="_blank"
                    rel="noopener noreferrer"
                    aria-label={`Ouvrir lâ€™article source : ${p.title}`}
                    style="text-decoration:none; color:inherit; background:#fff; border:1px solid #eaeaea; border-radius:14px; padding:16px; display:block; box-shadow:0 1px 2px rgba(0,0,0,.04);"
                  >
                    {p.imageUrl && (
                      <img
                        src={p.imageUrl}
                        alt={p.title}
                        loading="lazy"
                        style="display:block; width:100%; height:auto; max-height:260px; object-fit:contain; background:#f6f6f6; border-radius:10px; margin-bottom:10px;"
                      />
                    )}
                    <h3 style="margin:0 0 6px 0; line-height:1.25;">{p.title}</h3>
                    <div style="opacity:.7; font-size: 14px; margin-bottom:8px;">
                      {new Date(p.date).toLocaleDateString('fr-FR')}
                    </div>
                    <p style="margin-top:0; opacity:.9;">{p.summary}</p>

                    <div style="display:flex; align-items:center; gap:8px; margin-top:12px; font-size:13px; opacity:.9;">
                      {faviconOf(p.sourceUrl) && (
                        <img
                          src={faviconOf(p.sourceUrl)}
                          alt=""
                          width="16"
                          height="16"
                          style="border-radius:4px; flex:0 0 16px;"
                        />
                      )}
                      <span>{brandOf(p.sourceUrl)}</span>
                    </div>
                  </a>
                ))}
              </main>
            )
        }
      </div>

      <footer style="opacity:.6; font-size:12px; margin-top:32px;">
        Â© {new Date().getFullYear()} â€” ActualitÃ©s France
      </footer>
    </div>
  </body>
</html>
